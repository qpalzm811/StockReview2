提示词二：生成复杂形态识别因子（三角形、双底、VCP）
Role: 你是一名量化交易专家，擅长使用特征工程识别 K 线形态（Pattern Recognition）。
Task: 请帮我编写 Python 代码，识别以下三种复杂的形态，并要求结合成交量进行突破过滤：
Converging_Triangle (收敛三角形带量突破):
使用 ZigZag 逻辑或局部极值点寻找过去 40 天的高点和低点。
高点序列需逐渐降低（斜率为负），低点序列需逐渐抬高（斜率为正）。
识别突破点：收盘价向上突破高点连线，且当日成交量大于过去 20 日均量的 1.5 倍。
Double_Bottom (双底带量突破):
寻找两个局部的最低价 L1 和 L2，要求两者价差在 1.5% 以内。
两个底部之间的时间间隔在 10 到 40 个交易日之间。
识别突破点：股价放量突破两个底部之间的最高点（颈线），成交量需明显放大。
VCP_Pattern (波动紧缩形态):
识别股价在盘整期内的多次波段振幅。
要求波段振幅逐渐减小（例如：第一波 15% -> 第二波 8% -> 第三波 3%）。
当成交量缩至极低后，出现放量长阳突破时，标记为信号 1。
Requirement:
可以使用 scipy.signal.argrelextrema 来寻找局部极值。
请封装成函数 detect_patterns(df)，返回一个布尔型的信号列。
考虑到形态识别的复杂性，请在代码中详细注释识别每个形态的具体步骤。
给 Gemini 后的调试建议：
如果 Gemini 写的形态识别太复杂： 你可以追加提问：“请简化形态识别逻辑，改用滚动窗口（Rolling Window）获取最近 20 天的最高价和最低价，通过判断斜率来模拟三角形识别。”
如果数据量很大： 请使用 Numba 加速这些循环计算，或者确保完全使用 NumPy 向量化。”
可视化： 请帮我写一段高性能的使用 Matplotlib 或 Plotly 的代码，在 K 线图上把识别出的‘双底’或‘三角形’区域标注出来，方便我复盘。

请确保使用 rolling 或 shift 操作，严禁使用未来数据，确保识别到的突破信号在当前时间点是可交易的。

因子排名归一化 (Rank Normalization)： 在复盘时，不要看因子的绝对值，要看该因子在整个股票池中的百分比排名（0-1）。
IC分布分析： 在复盘界面显示该因子在过去12个月的信息系数 (IC)，如果IC近期剧烈波动，说明该因子在当前行情下失效。
多因子打分池： 推荐将 趋势线性度 + 量价相关性 + 波动率调整动量 组合成一个“综合择时得分”，只有得分超过0.8时才在K线上标注买入信号。